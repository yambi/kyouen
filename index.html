<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style type="text/css">
        .square {
            width: 32px;
            height: 32px;
            position: absolute;
            background: #ffffff;
        }

        .square:before {
            content: "";
            display: block;
            position: absolute;
            width: 1px;
            height: 32px;
            left: 15.5px;
            background: #000000;
        }

        .square:after {
            content: "";
            display: block;
            position: absolute;
            width: 32px;
            height: 1px;
            top: 15.5px;
            background: #000000;
        }
    </style>
    <script type="application/javascript">
        //<![CDATA[
        var size = 9;
        var piece;
        var board = [];
        var bs = new Array();

        var len = function (x1, y1, x2, y2) {
            return Math.sqrt((x1 - x2) * (x1 - x2) + (y1 - y2) * (y1 - y2));
        }

        function isZero(r) {
            return Math.abs(r) < 0.000001;
        }

        function check(x1, y1, x2, y2, x3, y3, x4, y4) {
            if (x1 == x4 && y1 == y4) return false;
            if (x2 == x4 && y2 == y4) return false;
            if (x3 == x4 && y3 == y4) return false;
            var ab = len(x1, y1, x2, y2);
            var cd = len(x3, y3, x4, y4);
            var bc = len(x2, y2, x3, y3);
            var da = len(x4, y4, x1, y1);
            var ac = len(x1, y1, x3, y3);
            var bd = len(x2, y2, x4, y4);
            return isZero(-ab * cd + bc * da + ac * bd) || isZero(ab * cd - bc * da + ac * bd) || isZero(ab * cd + bc * da - ac * bd);
        }

        var showBoard = function () {
            var b = document.getElementById("board");
            while (b.firstChild) {
                b.removeChild(b.firstChild);
            }
            for (var i = 0; i < size; i++) {
                loop:
                for (var j = 0; j < size; j++) {
                    if (board[i][j] == 2) board[i][j] = 0;
                    if (board[i][j] == 3) board[i][j] = 1;
                    for (var b1 = 0; b1 < bs.length; b1++) {
                        for (var b2 = b1 + 1; b2 < bs.length; b2++) {
                            for (var b3 = b2 + 1; b3 < bs.length; b3++) {
                                if (check(bs[b1] % size, Math.floor(bs[b1] / size), bs[b2] % size, Math.floor(bs[b2] / size), bs[b3] % size, Math.floor(bs[b3] / size), i, j)) {
                                    board[i][j] += 2;
                                    continue loop;
                                }
                            }
                        }
                    }
                }
            }

            for (var i = 0; i < size; i++) {
                for (var j = 0; j < size; j++) {
                    k = board[i][j];
                    if(document.getElementById("res").checked) k+=4;
                    if(document.getElementById("hint").checked) k+=8;
                    t = [0,1,0,1,0,1,0,2,0,1,3,4,0,1,3,5];
                    var c = piece[t[k]].cloneNode(true);

                    c.style.left = (i * 32) + "px";
                    c.style.top = (j * 32) + "px";
                    b.appendChild(c);
                    (function () {
                        var _i = i, _j = j;
                        c.onclick = function () {
                            if (board[_i][_j] == 0) {
                                board[_i][_j] = 1;
                                bs.push(_i + _j * size);
                            }
                            else if (board[_i][_j] == 1) {
                                board[_i][_j] = 0;
                                var nbs = new Array();
                                for (var k = 0; k < bs.length; k++) {
                                    if (bs[k] != _i + _j * size) nbs.push(bs[k]);
                                }
                                bs = nbs;
                            }
                            else if (board[_i][_j] == 2) {
                                board[_i][_j] = 3;
                                bs.push(_i + _j * size);
                            }
                            else if (board[_i][_j] == 3) {
                                board[_i][_j] = 2;
                                var nbs = new Array();
                                for (var k = 0; k < bs.length; k++) {
                                    if (bs[k] != _i + _j * size) nbs.push(bs[k]);
                                }
                                bs = nbs;
                            }
                            showBoard();
                        };
                    })();
                }
            }
            console.log(bs);
        }

        function kp(event) {
            console.log(pressedChar(event));
            if (event.keyCode == 13) reset();

            var char = pressedChar(event);
            if (char && !char.match(/\d/)) {
                return false;
            } else {
                return true;
            }
        }
        function pressedChar(event) {
            var code = 0;
            if (event.charCode === 0) {// Firefox, Safari control code
                code = 0;
            } else if (!event.keyCode && event.charCode) {// Firefox
                code = event.charCode;
            } else if (event.keyCode && !event.charCode) {// IE
                code = event.keyCode;
            } else if (event.keyCode == event.charCode) {// Safari
                code = event.keyCode;
            }
            if (32 <= code && code <= 126) {// not ASCII
                return String.fromCharCode(code);
            } else {
                return null;
            }
        }


        function reset() {
            bs = new Array();
            size = document.getElementById("size").value;
            if (size > 32) {
                document.getElementById("size").value = 32;
                size = 32;
            }
            if (size < 2) {
                document.getElementById("size").value = 2;
                size = 2;
            }
            board = [];
            for (var i = 0; i < size; i++) {
                board[i] = [];
                for (var j = 0; j < size; j++) {
                    board[i][j] = 0;
                }
            }
            showBoard();
        }

        onload = function () {
            piece = [document.getElementById("cell"), document.getElementById("bcell"), document.getElementById("rcell"), document.getElementById("ycell"), document.getElementById("ybcell"), document.getElementById("yrcell")];
            for (var i = 0; i < size; i++) {
                board[i] = [];
                for (var j = 0; j < size; j++) {
                    board[i][j] = 0;
                }
            }
            showBoard();
        };
        //]]>
    </script>
    <title>共円</title>
</head>

<body style="background-color:#e2e2e2;">
    <h1> 共円 (Kyouen) </h1>

    <p>
        Size: <input type="number" id="size" value="9" min="2" max="32" size="2" onkeypress="return kp(event)"
            onchange="reset()" style="text-align:right;ime-mode:disabled;background-color:#eeeeee;" />
        <input type="button" value="reset" onclick="reset()"><br>
        Result: <input type="checkbox" id="res" onchange="showBoard()">
        Hint: <input type="checkbox" id="hint" onchange="showBoard()">

    </p>




    <div id="board" style="position:relative; margin: 10px;" onselectstart="return false"></div>

    <div style="display:none">
        <div id="cell" class="square"></div>
        <div id="bcell" class="square"><span style="position:absolute;top:4px;left:8px">&#9679</span></div>
        <div id="rcell" class="square" style=""><span style=" position:absolute;top:4px;left:8px;z-index:2;color:red;">&#9679</span></div>
        <div id="ycell" class="square" style="background:yellow"></div>
        <div id="ybcell" class="square" style="background:yellow"><span style="position:absolute;top:4px;left:8px">&#9679</span></div>
        <div id="yrcell" class="square" style="background:yellow"><span style=" position:absolute;top:4px;left:8px;z-index:2;color:red;">&#9679</span></div>
    </div>

</body>

</html>